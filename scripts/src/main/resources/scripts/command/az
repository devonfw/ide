#!/usr/bin/env bash

# autocompletion list
if [ "${1}" = "shortlist" ]
then
  if [ -z "${2}" ]
  then
    echo "setup help"
  fi
  exit
fi

if [ -n "${DEVON_IDE_TRACE}" ]; then set -vx; fi
# shellcheck source=scripts/functions
source "$(dirname "${0}")"/../functions

function doSetup() {
  if [ ! -f "${AZ_FILE}" ] 
  then
    if [ ! -f "${PYTHON_FILE}" ] 
    then
      doDevonCommand python pip install azure-cli
      setPath
      setConfigDir
    else
      doDevonCommand python setup silent
      doDevonCommand python pip install azure-cli
      setPath
      setConfigDir
    fi
  fi
}
    
# Set directory for azure cli configuration file
function setConfigDir() {
  azureconf_dir="${DEVON_IDE_HOME}/conf/.azure"
  azurecli_export="export AZURE_CONFIG_DIR=${azureconf_dir}"
  if ! grep -q "${azurecli_export}" "${DEVON_IDE_HOME}/conf/devon.properties"
    then
      doRunCommand "${azurecli_export}"
      echo -e "\n${azurecli_export}" >> "${DEVON_IDE_HOME}/conf/devon.properties"
      doEcho "Location of Azure's configuration file is set to ${azureconf_dir}"
  fi
}

function setPath() {
  az_dir="${DEVON_IDE_HOME}/software/python/Scripts"
  path_bind='PATH=$PATH:'
  set_path="${path_bind}${az_dir}"
  if ! grep -q "${set_path}" "${DEVON_IDE_HOME}/conf/devon.properties"
    then
      doRunCommand "${set_path}"
      echo -e "\n${set_path}" >> "${DEVON_IDE_HOME}/conf/devon.properties"
      doEcho "Azure's Path is added to ${DEVON_IDE_HOME}/conf/devon.properties"
  fi
}

function doRun() {
  doSetup silent
  if [ -f "${AZ_FILE}" ] 
  then
    doEcho "Running: Azure CLI ${*}"
    az "${@}"
  fi
}

AZ_FILE="${DEVON_IDE_HOME}/software/python/Scripts/az"
PYTHON_FILE="${DEVON_IDE_HOME}/software/python/python"

# CLI
case ${1} in
"help" | "-h")
  echo "Install Azure CLI."
  echo
  echo "Arguments:"
  echo " setup                    install Azure CLI on your machine (global installation)."
  echo " <<args>>                 call Azure CLI with the specified arguments. Call az --help for details or use Azure CLI directly as preferred."
  echo
;;

"setup" | "s")
  doSetup "${2}"
;;

*)
  doRun "${@}"
;;
esac
