#!/usr/bin/env bash

# autocompletion list
if [ "${1}" = "shortlist" ]
then
  if [ -z "${2}" ]
  then
    echo "setup help"
  fi
  exit
fi

if [ -n "${DEVON_IDE_TRACE}" ]; then set -vx; fi
# shellcheck source=scripts/functions
source "$(dirname "${0}")"/../functions

# $1: optional setup
function doSetup() {
  installDir="${DEVON_IDE_HOME}/software/extra/graalvm"
  if doIsMacOs
  then
    GRAALVM_HOME="${DEVON_IDE_HOME}/software/extra/graalvm/Contents/Home"
  else
    GRAALVM_HOME="${installDir}"
  fi

  doDevonCommand java setup silent
  if [ ! -d "${installDir}" ]
  then
    local version="${GRAAL_VERSION:-22.0.0.2}"
    local javaVersion="${EXTRA_JAVA_VERSION}"
    if [ -z "${javaVersion}" ]
    then
      javaVersion="${JAVA_VERSION}"
    fi
    if [ -n "${javaVersion}" ]
    then
      doVersionCompare "${javaVersion}" "11u0"
      if [ "${?}" == 2 ]
      then
        # Java version is lower than 11
        doConfirmWarning "GraalVM requires Java 11 or newer.\nHowever, [EXTRA_]JAVA_VERSION is ${javaVersion} - in this setup GraalVM can not work.\nPlease update JAVA_VERSION or set EXTRA_JAVA_VERSION in your settings/devon.properties!"
      fi
    fi
    doInstall "-" "${installDir}" "graalvm" "${version}"
    echo -e "export GRAALVM_HOME=${GRAALVM_HOME}" >> "${DEVON_IDE_HOME}/conf/devon.properties"
    doExtendPath "${GRAALVM_HOME}"
  fi
  if [ "${1}" != "silent" ] && ! doIsQuiet
  then
    local java_binary="${GRAALVM_HOME}/bin/java"
    if [ ! -f "${java_binary}" ]
    then
      java_binary="${GRAALVM_HOME}/bin/java.exe"
    fi
    doRunCommand "'${java_binary}' -version" "verify installation of GraalVM"
  fi
  export GRAALVM_HOME
}

# Call GraalVM with specified arguments
function doRun() {
  doSetup silent
  command="$GRAALVM_HOME/bin/$*"
  local binary=${command%% *}
  local subcommand=${command/"$binary"/}
  if [ -f "${binary}" ]
  then
    binary=${binary}
  elif [ -f "${binary}.exe" ]
  then
    binary=${binary}".exe"
  else
    binary=${binary}".cmd"
  fi

  if [ -f "${binary}" ]
  then
    # shellcheck disable=SC2086
    "${binary}" ${subcommand}
  else
    doFail "Command not found"
  fi
}

# CLI
case ${1} in 
"help" | "-h")
  echo "Setup GraalVM."
  echo
  echo "Arguments:"
  echo " setup                    setup GraalVM (install and verify)"
  echo " «args»                   call GraalVM with the specified arguments"
  echo  
;;
"setup" | "s" | "")
  doSetup "${2}"
;;
*)
  doRun "${@}"
;;
esac